name: Release Pipeline

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bump:
    name: Bump Version
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      released: ${{ steps.semantic.outputs.released }}
      version: ${{ steps.semantic.outputs.version }}
      tag: ${{ steps.semantic.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Python Semantic Release
        id: semantic
        uses: python-semantic-release/python-semantic-release@v9.15.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          git_committer_name: "github-actions[bot]"
          git_committer_email: "github-actions[bot]@users.noreply.github.com"
          force: "patch"

  build:
    name: Build ${{ matrix.name }}
    needs: bump
    # Always run build - force flag ensures version always increments
    if: always() && needs.bump.result == 'success'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Windows x64
            os: windows-latest
            python-version: "3.11"
            artifact-name: FBScrapeIdeas-windows-x64.exe
            pyinstaller-args: --onefile --name FBScrapeIdeas-windows-x64
            
          - name: macOS Intel
            os: macos-latest
            python-version: "3.11"
            artifact-name: FBScrapeIdeas-macos-x64
            pyinstaller-args: --onefile --name FBScrapeIdeas-macos-x64
            
          - name: macOS Apple Silicon
            os: macos-latest
            python-version: "3.11"
            artifact-name: FBScrapeIdeas-macos-arm64
            pyinstaller-args: --onefile --name FBScrapeIdeas-macos-arm64
            
          - name: Linux x64
            os: ubuntu-latest
            python-version: "3.11"
            artifact-name: FBScrapeIdeas-linux-x64
            pyinstaller-args: --onefile --name FBScrapeIdeas-linux-x64
            
          - name: Linux ARM64
            os: ubuntu-24.04-arm
            python-version: "3.11"
            artifact-name: FBScrapeIdeas-linux-arm64
            pyinstaller-args: --onefile --name FBScrapeIdeas-linux-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-${{ runner.arch }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller ${{ matrix.pyinstaller-args }} \
            --add-data "ai/gemini_schema.json:ai" \
            --add-data "ai/gemini_comment_schema.json:ai" \
            --hidden-import=selenium \
            --hidden-import=google.generativeai \
            --hidden-import=bs4 \
            --hidden-import=dateparser \
            --hidden-import=tenacity \
            --hidden-import=requests \
            --hidden-import=dotenv \
            --collect-all google.generativeai \
            --noconfirm \
            --clean \
            main.py
        shell: bash

      - name: Verify executable exists (Unix)
        if: runner.os != 'Windows'
        run: |
          ls -la dist/
          chmod +x dist/${{ matrix.artifact-name }}

      - name: Verify executable exists (Windows)
        if: runner.os == 'Windows'
        run: |
          dir dist\
        shell: cmd

      - name: Test executable runs (Unix)
        if: runner.os != 'Windows'
        run: |
          ./dist/${{ matrix.artifact-name }} --help || echo "Note: --help may not be implemented, but executable runs"
        continue-on-error: true

      - name: Test executable runs (Windows)
        if: runner.os == 'Windows'
        run: |
          dist\${{ matrix.artifact-name }} --help || echo "Note: --help may not be implemented, but executable runs"
        shell: cmd
        continue-on-error: true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: dist/${{ matrix.artifact-name }}
          retention-days: 1

  release:
    name: Create Release
    needs: [bump, build]
    # Always run release - force flag ensures version always increments
    if: always() && needs.bump.result == 'success' && needs.build.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Move all executables to release-assets folder
          find artifacts -type f -name "FBScrapeIdeas-*" -exec mv {} release-assets/ \;
          
          # List all assets
          echo "Release assets:"
          ls -la release-assets/
          
          # Make Unix executables executable
          chmod +x release-assets/FBScrapeIdeas-macos-* release-assets/FBScrapeIdeas-linux-* 2>/dev/null || true

      - name: Generate SHA256 checksums
        run: |
          cd release-assets
          sha256sum FBScrapeIdeas-* > SHA256SUMS.txt
          echo "Checksums generated:"
          cat SHA256SUMS.txt

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.bump.outputs.version }}"
          
          # Find the previous tag (the one before the new tag)
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found. Including recent commits."
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges HEAD~20..HEAD 2>/dev/null || git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Previous tag: $PREV_TAG"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges ${PREV_TAG}..HEAD)
          fi
          
          # Save changelog to file
          echo "$CHANGELOG" > changelog.txt

      - name: Create release notes
        run: |
          VERSION="${{ needs.bump.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          cat << 'RELEASE_NOTES' > release_notes.md
          # üöÄ FB Scrape Ideas v${VERSION}
          
          A powerful Facebook group scraper with Google Gemini AI-powered categorization.
          
          ## üì¶ Downloads
          
          | Platform | Architecture | File |
          |----------|-------------|------|
          | Windows | x64 | `FBScrapeIdeas-windows-x64.exe` |
          | macOS | Intel (x64) | `FBScrapeIdeas-macos-x64` |
          | macOS | Apple Silicon (ARM64) | `FBScrapeIdeas-macos-arm64` |
          | Linux | x64 | `FBScrapeIdeas-linux-x64` |
          | Linux/Chromebook | ARM64 | `FBScrapeIdeas-linux-arm64` |
          
          > üí° **Tip**: Check `SHA256SUMS.txt` to verify your download integrity.
          
          ## üìã What's Changed
          
          RELEASE_NOTES
          
          # Append the changelog
          cat changelog.txt >> release_notes.md
          
          cat << 'RELEASE_NOTES_END' >> release_notes.md
          
          ## ‚öôÔ∏è System Requirements
          
          - **Chrome or Chromium browser** - Required for Selenium web scraping
          - **Google Gemini API key** - Required for AI-powered post categorization
          - **Internet connection** - Required for scraping and AI analysis
          
          ## üöÄ Quick Start
          
          1. **Download** the appropriate binary for your platform from the assets below.
          2. **Run the application**:
             - **Windows**: Double-click or run `FBScrapeIdeas-windows-x64.exe` in Command Prompt.
             - **macOS/Linux**: Open terminal and run the binary.
          
          On first launch, the application will guide you through an interactive setup to configure your API keys and credentials. No manual file creation is required!
          
          ## üîê Authentication
          
          On first run, you'll need to:
          1. Log in to Facebook through the browser window that opens
          2. The application will save your session for future use
          
          ## üìñ Documentation
          
          See the [README](https://github.com/${{ github.repository }}/blob/master/README.md) for detailed usage instructions.
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG:-initial}...${{ needs.bump.outputs.tag }}
          RELEASE_NOTES_END
          
          # Replace version placeholder
          sed -i "s/\${VERSION}/$VERSION/g" release_notes.md
          
          echo "Release notes generated:"
          cat release_notes.md

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump.outputs.tag }}
          name: FB Scrape Ideas v${{ needs.bump.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    name: Cleanup on Failure
    needs: [bump, build, release]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Report failure
        run: |
          echo "‚ùå Release workflow failed!"
          echo "Please check the logs above for details."
