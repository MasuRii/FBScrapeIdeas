# Competitive Feature Extraction & Code Analysis Report

**Date:** December 29, 2025
**Parent Goal:** Upgrade FB Scrape Ideas with industry-leading features from 2025 competitors.

---

## 1. Playwright Setup & Anti-Detection Strategies

### Context & User Agent
- **Competitors:** All analyzed repos have migrated to Playwright.
- **User Agent:** `benzh0u` and `yousef-hamda` use modern Chrome user-agents (Chrome 131+).
- **Anti-Detection:** 
    - `benzh0u` mimics human behavior with `random.uniform(2, 4)` delays between scrolls.
    - `yousef-hamda` uses a `humanDelay` utility for stochastic wait times.
    - Both use `headless: False` or `headless: "new"` to avoid standard headless detection.

### Storage State Persistence
The "secret sauce" for 2025 session management is Playwright's `storage_state`.
- **Implementation:** `thanh2004nguyen` uses a two-script approach:
    1. `login_and_save_state.py`: Opens a browser, waits for manual login, then calls `context.storage_state(path="facebook_state.json")`.
    2. `main.py`: Launches with `browser.new_context(storage_state="facebook_state.json")`.
- **Benefit:** This captures cookies, `localStorage`, and `sessionStorage`, making it far more resilient than Selenium's cookie-only approach.

---

## 2. AI Filtering Flow

### Real-time vs. Post-processing
- **`benzh0u` (Real-time Filtering):** 
    - **Keyword Pre-filter:** Filters posts locally by keywords *before* calling the AI.
    - **Cost Optimization:** Only sends potential matches to `gpt-4o-mini`.
    - **Immediate Action:** The AI confirms relevance during the scrape loop, allowing for immediate notifications.
- **`yousef-hamda` (Batch Post-processing):**
    - Scrapes raw posts to a database (`Prisma`).
    - A separate `classifyPosts` cron job processes pending posts in batches.
    - Uses **Structured Outputs** (`json_schema`) to get `is_historic`, `confidence`, and `reason`.

---

## 3. Scroll & Extraction Logic

### Infinite Scroll Handling
- **Our Current Implementation:** Uses `window.scrollTo(0, document.body.scrollHeight)` and fixed sleeps.
- **Competitor Best-in-Class (`yousef-hamda`):**
    - Uses `page.waitForFunction` to detect when skeleton placeholders are replaced by actual content (checking `article.textContent.length > 100`).
    - Gradually scrolls (`window.scrollBy(0, 800)`) instead of jumping to the bottom, which triggers FB's bot detection less frequently.

### Selector Resiliency (2025 DOM)
- **Primary:** `div[role="feed"] div[role="article"]`
- **Secondary:** `[data-pagelet^="FeedUnit"]`
- **Text Extraction:** `div[data-ad-comet-preview="message"]` (highly stable in 2025).

---

## 4. Harvestable Code Patterns

| Pattern | Source | Description |
|---------|--------|-------------|
| **Manual-to-Auto Session** | `thanh2004nguyen` | A "one-time login" utility that exports `storage_state` for headless reuse. |
| **Cost-Aware AI Filter** | `benzh0u` | `Local Keyword Search` -> `AI Verification` -> `DB Store`. |
| **DOM-Ready Waiter** | `yousef-hamda` | `waitForFunction` checking for real text vs. loading spinners. |
| **Structured AI Schema** | `yousef-hamda` | Using `json_schema` response format for classification to avoid parsing errors. |
| **Discussion Tab Anchor** | `yousef-hamda` | Explicitly clicking the "Discussion" tab to bypass "Featured" or "About" landing pages. |
| **Selector Fallback List** | `yousef-hamda` | Iterating through an array of selectors until the first match is found. |

---

## 5. Recommended Technical Roadmap

1. **Port to Playwright:** Shift from Selenium to Playwright to leverage `storage_state` and better async performance.
2. **Implement Session Manager:** Create a `auth/session_manager.py` that handles the `storage_state` lifecycle.
3. **Upgrade AI Service:** Move to structured JSON outputs and implement the keyword pre-filter seen in `benzh0u`.
4. **Resilient Selectors:** Adopt the multi-selector fallback pattern for 2025 FB UI.

---
*Report generated by Code Mode.*
